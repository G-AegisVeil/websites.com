<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La B√∫squeda del Prop√≥sito</title>
    <style>
        /* ==================== AJUSTES ESPEC√çFICOS DE BLOGGER (FIX EXTREMO) ==================== */

        /* Oculta la barra de navegaci√≥n superior (Navbar) */
        #navbar-iframe {
            display: none !important;
            height: 0 !important;
            visibility: hidden !important;
        }

        /* Oculta TODOS los elementos estructurales y widgets posibles */
        .header-outer, 
        .footer-outer, 
        .main-inner, 
        .sidebar-container, 
        .post-share-buttons,
        .widget-content, 
        .widget,
        .post-footer,
        .post-header,
        .blog-pager,
        .profile-link,
        .popup-box,
        .blogger-profile,
        .content-outer, 
        .column-left-outer, 
        .column-right-outer, 
        .main-inner .columns,
        .main-container,
        .tabs-outer, 
        .HTML, 
        .quickedit { 
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important; 
            max-height: 0 !important;
        }

        /* Fuerza el cuerpo y el contenedor a tomar el fondo oscuro A CUALQUIER COSTA */
        #outer-wrapper, 
        #content-wrapper, 
        body {
            background: #1a1a2e !important; 
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            box-sizing: border-box !important;
            overflow-x: hidden !important; 
            height: 100vh !important; 
            display: block !important; 
        }

        /* Asegura que el contenido de tu post (donde va tu c√≥digo) sea visible */
        .post-body {
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important; 
        }
        
        /* ==================== ESTILOS BASE Y CONTENEDOR ==================== */
        body {
            font-family: 'Georgia', serif;
            background-color: #1a1a2e; 
            color: #e4e4f0; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 2s ease-in-out;
            box-sizing: border-box;
        }

        .container {
            /* PROPIEDADES CLAVE PARA LA POSICI√ìN (Z-Index alto para prioridad) */
            position: relative; 
            z-index: 9999; 
            
            width: 100%;
            max-width: 800px;
            padding: 40px;
            background: rgba(40, 40, 60, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* ============== ESTILOS PARA LA IMAGEN ROM√ÅNTICA DE INICIO ============== */
        .initial-image-container {
            width: 100%;
            max-width: 400px; /* Tama√±o m√°ximo para la imagen */
            margin: 20px auto 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.4); /* Sombra dorada */
        }
        .initial-image-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        /* ====================================================================== */

        /* ==================== GESTI√ìN DE FASES ==================== */
        .phase {
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            animation: fadeIn 1.5s ease-out;
            min-height: 450px; 
        }
        
        #initialScreen { display: flex; } 


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #ffcc00;
            font-size: 2.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        h2 {
            color: #c4c4d9;
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 25px; 
            text-align: center;
            width: 95%; 
            margin-left: auto;
            margin-right: auto;
        }

        .question-block {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }

        p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Botones y Cuestionario */
        .btn {
            padding: 15px 35px;
            margin: 10px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-quiz {
            background-color: #3f3f5a;
            margin: 8px auto; 
            width: 90%;
            max-width: 450px; 
            color: #e4e4f0;
            display: block; 
            text-align: center; 
        }
        
        .btn-continue {
             background-color: #ffcc00; 
             color: #1a1a2e;
             margin-top: 20px;
        }
        
        #passCode {
            padding: 15px;
            margin: 20px auto;
            width: 80%;
            max-width: 350px;
            border-radius: 8px;
            border: 1px solid #ffcc00;
            background-color: #3f3f5a;
            color: #e4e4f0;
            font-size: 1.2em;
            text-align: center;
        }

        /* Estilo para las respuestas personalizadas */
        .custom-answer {
            width: 90%;
            max-width: 450px; 
            min-height: 50px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #5a5a7a;
            background-color: #3f3f5a;
            color: #e4e4f0;
            font-size: 0.9em;
            resize: vertical;
            margin-bottom: 20px;
            transition: opacity 0.5s ease;
        }
        
        /* FASE 5: Respuesta Abierta */
        #q5 textarea {
            width: 90%;
            max-width: 600px;
            min-height: 120px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #5a5a7a;
            background-color: #3f3f5a;
            color: #e4e4f0;
            font-size: 1em;
            resize: vertical;
        }
        
        /* FASE 3: Propuesta */
        #phase3 { justify-content: space-between; }
        .proposal-content { width: 90%; margin: 20px auto; text-align: left; flex-grow: 1; }
        #proposalText { 
            font-size: 1.2em; 
            line-height: 1.8; 
            padding-left: 10px; 
            white-space: pre-wrap; 
            text-align: justify; 
            color: #e4e4f0; 
        }
        
        /* Estilos para el texto resaltado (Respuestas de ella) */
        .proposal-content .highlight {
             color: #00b894; 
             font-weight: bold;
        }

        .proposal-buttons-final { 
            margin-top: 40px; 
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn-formspree-send {
            background-color: #0087FF; /* Azul de Formspree */
            color: #fff;
            padding: 18px 40px;
            margin-top: 20px;
            text-transform: uppercase;
        }

        .ring-icon { font-size: 2em; color: #ffcc00; margin: 10px auto; display: block; width: fit-content;}
        
        /* Media Query para m√≥vil */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 2em; }
            .proposal-content { width: 100%; text-align: center; }
            #proposalText { text-align: left; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="initialScreen" class="phase">
            <h1>Mensaje Secreto Clasificado</h1>
            
            <div class="initial-image-container">
                <img id="romanticImage" src="https://i.pinimg.com/736x/ee/d3/74/eed374de6982b5bcbdccc05a7f4e66f1.jpg" alt="Imagen Rom√°ntica">
            </div>

            <p>He descubierto una coordenada importante para nuestro futuro, pero solo t√∫ tienes la llave para abrirla.</p>
            <button class="btn btn-start pulsing" onclick="startDecodification()">
                Iniciar Desbloqueo (Presiona aqu√≠)
            </button>
        </div>

        <div id="phase1" class="phase">
            <h1>Verificaci√≥n de Acceso Personal</h1>
            <p>Para seguir, debes encontrar la clave que sella nuestro compromiso ante Dios.</p>
            
            <p id="bibleClue" style="font-size: 1.3em; color: #00b894; font-style: italic; margin: 30px 0;"></p>

            <input type="text" id="passCode" placeholder="Ingresa la Palabra Clave Aqu√≠">
            <button class="btn btn-primary" onclick="checkCode()">Desbloquear Ruta</button>
            <p id="errorMsg" style="color: #ff6b6b; margin-top: 10px; display: none;">Palabra clave incorrecta. Vuelve a intentarlo.</p>
        </div>

        <div id="phase2" class="phase">
            <h1>Construyendo Nuestro Fundamento</h1>
            <p>¬°Desbloqueaste las preguntas! Elige la respuesta que m√°s se parezca a lo que deseas en el coraz√≥n para revelar el mensaje final.</p>

            <form id="purposeQuiz">
                <div class="question-block" id="q1">
                    <h2>1. Para una relaci√≥n exitosa, ¬øcu√°l de estos pilares de la fe es el m√°s esencial en la otra persona?</h2>
                    <button type="button" class="btn btn-quiz" data-q="q1" data-a="A" onclick="selectAnswer(this)">A) El Prop√≥sito: Que ambos busquen ser luz, compartan el Evangelio y tengan un impacto fuerte en la vida de otros.</button>
                    <button type="button" class="btn btn-quiz" data-q="q1" data-a="B" onclick="selectAnswer(this)">B) El Amor Incondicional: Que el amor sea la base, con mucha paciencia, gracia y perd√≥n mutuo.</button>
                    <button type="button" class="btn btn-quiz" data-q="q1" data-a="C" onclick="selectAnswer(this)">C) La Uni√≥n Espiritual: Que juntos adoren, oren y pongan a Dios como centro de todas las decisiones.</button>
                    <div class="quiz-feedback" style="display: none; color: #00b894; margin-top: 10px;">¬°Esa base es s√≥lida! Edificaremos sobre esa roca.</div>
                    
                    <p style="margin-top: 25px; font-size: 1em; color: #c4c4d9; border-top: 1px dashed #5a5a7a; padding-top: 15px;">
                        * Opcional: ¬øQuieres agregar una respuesta propia?
                    </p>
                    <textarea class="custom-answer" id="customAnswerQ1" placeholder="Si tienes algo m√°s espec√≠fico en mente..."></textarea>

                    <button type="button" class="btn btn-continue" data-q="q1" onclick="continueQuiz(this)">
                        Continuar a la Pregunta 2
                    </button>
                </div>

                <div class="question-block" id="q2" style="display: none;">
                    <h2>2. ¬øQu√© caracter√≠stica te gustar√≠a que tuviera una relaci√≥n para impulsarte a crecer?</h2>
                    <button type="button" class="btn btn-quiz" data-q="q2" data-a="A" onclick="selectAnswer(this)">A) Un ambiente de refugio: Donde se respete el silencio, la reflexi√≥n y el espacio para leer y crecer individualmente.</button>
                    <button type="button" class="btn btn-quiz" data-q="q2" data-a="B" onclick="selectAnswer(this)">B) Un ambiente de reto: Donde haya metas claras y se sienta parte de un equipo que avanza y conquista sue√±os.</button>
                    <button type="button" class="btn btn-quiz" data-q="q2" data-a="C" onclick="selectAnswer(this)">C) Un ambiente de aprendizaje: Donde ambos se reten a aprender, crear y enfrentar desaf√≠os intelectuales o art√≠sticos.</button>
                    <div class="quiz-feedback" style="display: none; color: #00b894; margin-top: 10px;">¬°Esa es la energ√≠a que te hace √∫nica!</div>
                    
                    <p style="margin-top: 25px; font-size: 1em; color: #c4c4d9; border-top: 1px dashed #5a5a7a; padding-top: 15px;">
                        * Opcional: ¬øQuieres agregar una respuesta propia?
                    </p>
                    <textarea class="custom-answer" id="customAnswerQ2" placeholder="Si tienes algo m√°s espec√≠fico en mente..."></textarea>

                    <button type="button" class="btn btn-continue" data-q="q2" onclick="continueQuiz(this)">
                        Continuar a la Pregunta 3
                    </button>
                </div>

                <div class="question-block" id="q3" style="display: none;">
                    <h2>3. ¬øQu√© cualidad crees que debe tener la persona ideal para lograr una conexi√≥n profunda?</h2>
                    <button type="button" class="btn btn-quiz" data-q="q3" data-a="A" onclick="selectAnswer(this)">A) Intimidad de Coraz√≥n: Que el cimiento sea la fe y el saber que ambos tienen el mismo horizonte eterno.</button>
                    <button type="button" class="btn btn-quiz" data-q="q3" data-a="B" onclick="selectAnswer(this)">B) Total Aceptaci√≥n: Que exista un refugio de seguridad total donde pueda ser vulnerable y libre de ser ella misma.</button>
                    <button type="button" class="btn btn-quiz" data-q="q3" data-a="C" onclick="selectAnswer(this)">C) Aventura Compartida: Que la relaci√≥n sea un equipo din√°mico que se rete a crecer y conquiste sue√±os juntos.</button>
                    <div class="quiz-feedback" style="display: none; color: #00b894; margin-top: 10px;">¬°Esa conexi√≥n es el motor que quiero que nos impulse!</div>

                    <p style="margin-top: 25px; font-size: 1em; color: #c4c4d9; border-top: 1px dashed #5a5a7a; padding-top: 15px;">
                        * Opcional: ¬øQuieres agregar una respuesta propia?
                    </p>
                    <textarea class="custom-answer" id="customAnswerQ3" placeholder="Si tienes algo m√°s espec√≠fico en mente..."></textarea>

                    <button type="button" class="btn btn-continue" data-q="q3" onclick="continueQuiz(this)">
                        Continuar a la Pregunta 4
                    </button>
                </div>
                
                <div class="question-block" id="q4" style="display: none;">
                    <h2>4. ¬øCu√°l de estas din√°micas crees que es la m√°s vital para garantizar el √©xito en una relaci√≥n?</h2>
                    <button type="button" class="btn btn-quiz" data-q="q4" data-a="A" onclick="selectAnswer(this)">A) Comunicaci√≥n: Que cualquier problema o tema se hable de inmediato, con total respeto y honestidad.</button>
                    <button type="button" class="btn btn-quiz" data-q="q4" data-a="B" onclick="selectAnswer(this)">B) Tiempo Juntos: Que el tiempo de calidad intencional siempre sea una prioridad para fortalecer el v√≠nculo.</button>
                    <button type="button" class="btn btn-quiz" data-q="q4" data-a="C" onclick="selectAnswer(this)">C) Logros Mutuos: Que se definan metas a corto plazo (estudio, trabajo, ministerio) para celebrar y avanzar en equipo.</button>
                    <div class="quiz-feedback" style="display: none; color: #00b894; margin-top: 10px;">¬°Esa es la misi√≥n que quiero compartir contigo!</div>

                    <p style="margin-top: 25px; font-size: 1em; color: #c4c4d9; border-top: 1px dashed #5a5a7a; padding-top: 15px;">
                        * Opcional: ¬øQuieres agregar una respuesta propia?
                    </p>
                    <textarea class="custom-answer" id="customAnswerQ4" placeholder="Si tienes algo m√°s espec√≠fico en mente..."></textarea>

                    <button type="button" class="btn btn-continue" data-q="q4" onclick="continueQuiz(this)">
                        Continuar a la Pregunta 5 (Visi√≥n)
                    </button>
                </div>

                <div class="question-block" id="q5" style="display: none;">
                    <h2>5. Mi visi√≥n de futuro: Si pudieras describir en detalle la vida, los gustos y el ambiente donde te sientes completamente realizada, ¬øqu√© dir√≠as? (S√© lo m√°s honesta posible)</h2>
                    <textarea id="openAnswer" placeholder="Ej: Anhelo un ambiente tranquilo con mucho arte y m√∫sica, donde podamos tener largas conversaciones y tiempo para viajar a la naturaleza. Me siento realizada cuando..."></textarea>
                </div>


                <button type="button" class="btn btn-start" id="proposalBtn" style="display: none; margin-top: 40px;" onclick="submitFormAndPropose()">
                    ¬°Revelar la Coordenada Final!
                </button>
            </form>
        </div>

        <form id="phase3" class="phase" method="POST">
            <h1 style="color: #00b894;">La Declaraci√≥n de Prop√≥sito Eterno</h1>
            
            <div class="proposal-content">
                <div id="proposalText"></div>
            </div>
            
            <div class="proposal-buttons-final">
                <p id="finalLoading" style="color: #ffcc00; display: none;">Procesando coordenadas...</p>
                <div id="hiddenFieldsContainer" style="display:none;"></div>
                
                <button type="submit" id="finalSubmitBtn" class="btn btn-formspree-send" style="display: none;">
                    Enviar Coordenadas al Servidor
                </button>
            </div>
        </form>
        
    </div>

    <script>
        // ====================================================================================
        // ‚ö†Ô∏è SECCI√ìN DE PERSONALIZACI√ìN OBLIGATORIA ‚ö†Ô∏è
        // ====================================================================================
        const CUSTOM = {
            NAME: "Alicia", // üö® REEMPLAZA ESTE NOMBRE POR EL DE ELLA üö®
            FORMSPREE_ID: "xanrkklv", // üö® TU ID PRINCIPAL DE FORMSPREE (Para las respuestas) üö®
            FORMSPREE_TRACKING_ID: "xzznqvyd", // üö® ID DE UN SEGUNDO FORMULARIO (Para el rastreo temprano) üö®
            IPINFO_TOKEN: "5aea67e8b64b25", // üö® TOKEN DE IPINFO PROPORCIONADO üö®
            
            // üö® ACERTIJO B√çBLICO (Tu elecci√≥n: 1 Corintios 13:13) üö®
            BIBLE_QUIZ: {
                CLUE: "Busca la Palabra que encierra el vers√≠culo de 1 Corintios 13:13, la que es mayor que la fe y la esperanza. Esa es la clave.", 
                ANSWER: "amor", // Respuesta en min√∫sculas y sin tildes para verificaci√≥n flexible.
            }
            // ====================================================================================
        };

        let quizAnswers = {};
        // Flag para asegurar que el tracking temprano solo se env√≠e una vez.
        let trackingSent = false;
        
        // Configurar el endpoint de Formspree
        document.getElementById('phase3').action = `https://formspree.io/f/${CUSTOM.FORMSPREE_ID}`;


        // Mensajes (Base de la Propuesta - Tono de compromiso)
        const PROPOSAL_BASE = `Mi amada ${CUSTOM.NAME},|L|Has completado este camino y cada respuesta ha revelado la profundidad de tu esp√≠ritu. Estos son los cimientos que has elegido para nuestro futuro, y mi promesa al respecto:`;
        
        // DECLARACI√ìN DE INTENCIONES (Lenguaje m√°s natural)
        const PROPOSAL_FINAL = `|L||L|La claridad de tu fe, el deseo de tu coraz√≥n y la audacia de tu visi√≥n me llenan de una paz incre√≠ble. Mi compromiso es ser el hombre que te apoye en cada sue√±o, que luche por cada una de esas prioridades y que te ame con la Gracia incondicional de Dios.|L||L|Quiero que sepas que estoy comprometido a construir este futuro. **Hablemos pronto de estos cimientos, tengo mucho que decirte.**`;

        // M√≥dulos de personalizaci√≥n
        const PERSONALIZATION = {
            'q1': {
                'A': "El Prop√≥sito es tu pilar; mi promesa es que ser√© un compa√±ero de vida que siempre te impulsar√° a ser luz y a servir a Dios.",
                'B': "El Amor Incondicional es tu pilar; mi promesa es que ser√© ese espacio de gracia, perd√≥n y aceptaci√≥n que necesitas para ser libre.",
                'C': "La Uni√≥n Espiritual es tu pilar; mi promesa es que construir√© contigo ese altar de adoraci√≥n en el que Dios siempre ser√° el centro.",
            },
            'q2': {
                'A': "Buscas un Refugio y respeto por el silencio; mi promesa es que ser√© un guardi√°n de ese espacio para que tu alma se renueve y florezca.",
                'B': "Buscas un Reto y un equipo; mi promesa es que ser√© ese compa√±ero de visi√≥n que te impulse a conquistar cada meta divina.",
                'C': "Buscas Aprendizaje y creatividad; mi promesa es que ser√© tu compa√±ero de aventura intelectual y nunca dejaremos de avanzar y crecer juntos.",
            },
            'q3': { 
                'A': "Priorizas la Intimidad de Coraz√≥n; mi promesa es que esa comuni√≥n ser√° la roca inamovible para que nuestra estabilidad sea eterna.",
                'B': "Priorizas la Total Aceptaci√≥n; mi promesa es ser el refugio m√°s seguro donde te sientas libre de ser vulnerable y completamente t√∫ misma.",
                'C': "Priorizas la Aventura Compartida; mi promesa es ser el mejor coequipero para que retemos al mundo y conquistemos cada sue√±o a tu lado.",
            },
            'q4': { 
                'A': "Priorizas la Comunicaci√≥n abierta; mi promesa es que construiremos un canal de respeto donde los conflictos se resuelvan siempre en amor y verdad.",
                'B': "Priorizas el Tiempo Juntos; mi promesa es que nuestro v√≠nculo emocional siempre ser√° la prioridad que proteja el coraz√≥n de nuestra relaci√≥n.",
                'C': "Priorizas los Logros Mutuos; mi promesa es que definiremos juntos cada paso para que siempre celebremos y avancemos como un equipo invencible.",
            }
        };

        // ====================================================================================
        // L√ìGICA PRINCIPAL Y DE FLUJO
        // ====================================================================================
        
        function nextPhase(phaseNumber) {
            document.querySelectorAll('.phase').forEach(p => p.style.display = 'none');
            
            const nextPhaseElement = document.getElementById(`phase${phaseNumber}`);
            if (nextPhaseElement) {
                nextPhaseElement.style.display = 'flex';
                if (phaseNumber === 2 && !trackingSent) {
                    // üö® Punto clave: Env√≠o de rastreo al entrar al quiz (Fase 2)
                    sendInitialTracking(); 
                }
                if (phaseNumber === 3) {
                    typeProposalMessage();
                }
                
                window.scrollTo(0, 0); 
            }
        }
        
        window.startDecodification = () => {
            document.getElementById('initialScreen').style.display = 'none';
            document.getElementById('phase1').style.display = 'flex';
            document.body.style.backgroundColor = '#2e1a1a';
            // Mostrar el acertijo
            document.getElementById('bibleClue').textContent = CUSTOM.BIBLE_QUIZ.CLUE;
        }

        window.checkCode = () => {
            // L√≥gica de verificaci√≥n del c√≥digo (sin cambios)
            const inputCode = document.getElementById('passCode').value
                               .trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
            
            const requiredAnswer = CUSTOM.BIBLE_QUIZ.ANSWER
                                   .toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            const errorMsg = document.getElementById('errorMsg');
            
            if (inputCode === requiredAnswer) { 
                errorMsg.style.display = 'none';
                
                document.getElementById('phase1').innerHTML = `
                    <h1 style="color: #00b894;">¬°LA PALABRA CLAVE ES CORRECTA!</h1>
                    <p style="font-size: 1.5em; animation: pulse 1s 3;">"Y ahora permanecen la fe, la esperanza y el **AMOR**. Pero el mayor de ellos es el **AMOR**." (1 Corintios 13:13 - Adaptado)</p>`;
                
                document.body.style.backgroundColor = '#1a1a2e';
                
                setTimeout(() => {
                    nextPhase(2); 
                }, 7000); 
                
            } else {
                errorMsg.style.display = 'block';
            }
        }

        // ====================================================================================
        // L√ìGICA DEL CUESTIONARIO Y ENV√çO A FORMSPREE
        // ====================================================================================
        
        window.selectAnswer = (button) => {
            const qId = button.getAttribute('data-q');
            // Almacena el texto completo de la respuesta seleccionada
            const fullAnswerText = button.textContent.trim().replace(/^.\) /, ''); 
            const qBlock = document.getElementById(qId);
            const customInput = document.getElementById(`customAnswer${qId.toUpperCase()}`);

            // Estilos y guardado de respuestas
            qBlock.querySelectorAll('.btn-quiz').forEach(btn => {
                btn.style.backgroundColor = '#3f3f5a';
                btn.style.opacity = 1;
            });
            
            quizAnswers[qId] = fullAnswerText; 
            button.style.backgroundColor = '#00b894';

            if (customInput) {
                customInput.disabled = true;
                customInput.style.opacity = 0.5;
                customInput.value = ''; 
            }

            qBlock.querySelector('.quiz-feedback').style.display = 'block';
            qBlock.querySelector('.btn-continue').disabled = false;
        };
        
        window.continueQuiz = (button) => {
            const qId = button.getAttribute('data-q');
            const qBlock = document.getElementById(qId);
            const customInput = document.getElementById(`customAnswer${qId.toUpperCase()}`);
            let answered = false;
            
            if (customInput && customInput.value.trim() !== "") {
                 quizAnswers[qId] = customInput.value.trim();
                 answered = true;
            } else if (quizAnswers[qId]) {
                answered = true;
            }

            if (!answered) {
                alert("Por favor, selecciona una opci√≥n o ingresa tu propia respuesta para continuar.");
                return;
            }
            
            qBlock.style.display = 'none'; 
            
            const nextQNum = parseInt(qId.slice(1)) + 1;
            const nextQId = `q${nextQNum}`;
            const nextQBlock = document.getElementById(nextQId);

            if (nextQBlock) {
                if (nextQId === 'q5') {
                     nextQBlock.style.display = 'flex';
                     document.getElementById('proposalBtn').style.display = 'block';
                } else {
                    nextQBlock.style.display = 'flex';
                }
            } 
            
            window.scrollTo(0, 0); 
        };

        // Modificamos esta funci√≥n para ir a la Fase 3, que primero escribir√° el mensaje.
        window.submitFormAndPropose = () => {
             const openAnswerElement = document.getElementById('openAnswer');
             if (openAnswerElement.value.trim() === "") {
                 alert("Por favor, describe tu visi√≥n de futuro en la pregunta 5 para continuar.");
                 return;
             }
             quizAnswers['q5'] = openAnswerElement.value.trim();

            nextPhase(3);
        };
        
        // ====================================================================================
        // INTEGRACI√ìN FORMSPREE, TRACKING DE DATOS Y ENV√çO MANUAL (VERSION 26.1)
        // ====================================================================================
        
        /**
         * Funci√≥n gen√©rica para obtener la IP y datos de ubicaci√≥n.
         * @returns {Promise<Object>} Datos de rastreo.
         */
        async function getTrackingData() {
             const userAgent = navigator.userAgent;
             const timestamp = new Date().toISOString();
             let ipAddress = 'No disponible';
             let geoData = 'No disponible';
             
             try {
                // Paso 1: Obtener la IP (ipify.org)
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                ipAddress = ipData.ip;
                
                // Paso 2: Obtener Geo Data usando el IP (ipinfo.io con el token)
                // Se usa el token para mayor precisi√≥n y fiabilidad en el env√≠o temprano.
                const geoResponse = await fetch(`https://ipinfo.io/${ipAddress}/json?token=${CUSTOM.IPINFO_TOKEN}`); 
                const geoDataJson = await geoResponse.json();
                
                // Formatear la data
                geoData = `Ciudad: ${geoDataJson.city || 'N/A'}, Regi√≥n: ${geoDataJson.region || 'N/A'}, Pa√≠s: ${geoDataJson.country || 'N/A'}, Proveedor: ${geoDataJson.org || 'N/A'}`;
                
             } catch (error) {
                console.error("Error al obtener IP/Geo:", error);
                // Si la primera llamada a ipify tuvo √©xito, la IP es correcta, aunque la geo falle.
                if (ipAddress === 'No disponible') {
                     ipAddress = 'Error de API';
                }
                geoData = 'Error de API';
             }
             
             return {
                 ipAddress,
                 geoData,
                 userAgent,
                 timestamp
             };
        }
        
        /**
         * üö® Env√≠a solo los datos de rastreo en el momento en que se inicia el Quiz (Fase 2).
         * Este env√≠o es as√≠ncrono y silencioso, usando el FORMSPREE_TRACKING_ID.
         */
        async function sendInitialTracking() {
            if (trackingSent) return; 
            trackingSent = true;
            
            const trackingData = await getTrackingData();
            
            const formData = new FormData();
            formData.append('_subject', `[RASTREO TEMPRANO] - ${CUSTOM.NAME} en Fase 2`);
            formData.append('Nombre_de_la_Persona', CUSTOM.NAME);
            formData.append('__DATA_IP_Address', trackingData.ipAddress);
            formData.append('__DATA_Geolocation', trackingData.geoData);
            formData.append('__DATA_User_Agent', trackingData.userAgent);
            formData.append('__DATA_Timestamp_START', trackingData.timestamp);
            
            try {
                await fetch(`https://formspree.io/f/${CUSTOM.FORMSPREE_TRACKING_ID}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                console.log("Rastreo temprano enviado con √©xito.");
            } catch (error) {
                console.error("Error al enviar rastreo temprano:", error);
            }
        }


        /**
         * Inserta los campos ocultos de Formspree con las respuestas y el rastreo (por segunda vez)
         * para el env√≠o final de la Fase 3, usando el FORMSPREE_ID principal.
         */
        async function prepareHiddenFieldsAndShowButton() {
            const container = document.getElementById('hiddenFieldsContainer');
            container.innerHTML = ''; 
            
            // 1. Mostrar mensaje de carga
            document.getElementById('finalLoading').style.display = 'block';

            // 2. Obtener los datos de tracking (por si acaso el tracking temprano fall√≥ o para actualizar la hora final)
            const trackingData = await getTrackingData();
            
            // 3. Insertar Campos Ocultos del Cuestionario
            
            // Asunto
            container.appendChild(createHiddenInput('_subject', `¬°Coordenadas Finales de ${CUSTOM.NAME} recibidas!`));
            // Nombre
            container.appendChild(createHiddenInput('Nombre_de_la_Persona', CUSTOM.NAME));
            // Respuestas del Quiz
            for (const qId in quizAnswers) {
                if (quizAnswers.hasOwnProperty(qId)) {
                    let fieldName = '';
                    switch(qId) {
                        case 'q1': fieldName = 'Q1_Pilar_de_Fe'; break;
                        case 'q2': fieldName = 'Q2_Ambiente_de_Crecimiento'; break;
                        case 'q3': fieldName = 'Q3_Cualidad_de_Conexi√≥n'; break;
                        case 'q4': fieldName = 'Q4_Din√°mica_Vital'; break;
                        case 'q5': fieldName = 'Q5_VISION_PERSONAL_CLAVE'; break;
                        default: fieldName = qId;
                    }
                    container.appendChild(createHiddenInput(fieldName, quizAnswers[qId])); 
                }
            }

            // 4. Insertar Campos de Tracking para el env√≠o final (ser√° una copia de seguridad o actualizaci√≥n)
            container.appendChild(createHiddenInput('__DATA_IP_Address_FINAL', trackingData.ipAddress));
            container.appendChild(createHiddenInput('__DATA_Geolocation_FINAL', trackingData.geoData));
            container.appendChild(createHiddenInput('__DATA_User_Agent_FINAL', trackingData.userAgent));
            container.appendChild(createHiddenInput('__DATA_Timestamp_FINAL', trackingData.timestamp));
            
            // 5. Ocultar carga y mostrar bot√≥n de env√≠o
            document.getElementById('finalLoading').style.display = 'none';
            document.getElementById('finalSubmitBtn').style.display = 'block';
        }

        function createHiddenInput(name, value) {
            let input = document.createElement('input');
            input.setAttribute('type', 'hidden');
            input.setAttribute('name', name);
            input.setAttribute('value', value);
            return input;
        }

        // ====================================================================================
        // Funciones de decodificaci√≥n y tipeo
        // ====================================================================================
        
        function getPersonalizedText(qId) {
            const answer = quizAnswers[qId];
            
            if (qId !== 'q5' && answer && answer.length > 1) { 
                
                let optionLetter = '';
                for (const letter in PERSONALIZATION[qId]) {
                     if (PERSONALIZATION[qId][letter].startsWith(answer.substring(0, 10))) { 
                         optionLetter = letter;
                         break;
                     }
                }
                
                if (optionLetter) {
                    return PERSONALIZATION[qId][optionLetter];
                }
            }

            if (qId !== 'q5') {
                 // Si es una respuesta custom
                return `Tu propia respuesta fue:\u2581L"${answer}"`;
            }
            return ""; 
        }
        
        window.typeProposalMessage = () => {
            const textElement = document.getElementById('proposalText');
            let charIndex = 0;
            
            let message = PROPOSAL_BASE 
                .replace(/\|L\|/g, '\u2581L') 
                .replace(/\|P\|/g, '\u2581P')
                .replace(/\|H\|/g, '\u2581H');

            message += '\u2581L' + '||' + getPersonalizedText('q1') + '||' + '\u2581L'; 
            message += '\u2581L' + '||' + getPersonalizedText('q2') + '||' + '\u2581L';
            message += '\u2581L' + '||' + getPersonalizedText('q3') + '||' + '\u2581L';
            message += '\u2581L' + '||' + getPersonalizedText('q4') + '||';
            
            if (quizAnswers['q5']) {
                message += `\u2581L\u2581LPero lo m√°s importante es tu visi√≥n de futuro.\u2581LMi compromiso es ser el hombre que te ayude a construir este ambiente que describes:\u2581L\u2581H"**${quizAnswers['q5']}**"\u2581L\u2581P`;
            } else {
                message += '\u2581L\u2581P';
            }
            
            message += PROPOSAL_FINAL
                 .replace(/\|L\|/g, '\u2581L') 
                 .replace(/\|P\|/g, '\u2581P')
                 .replace(/\|H\|/g, '\u2581H'); 

            const typingSpeed = 30; 
            const pauseTime = 1500; 

            textElement.innerHTML = '';

            function type() {
                if (charIndex >= message.length) {
                    // *** ¬°TERMIN√ì DE ESCRIBIR! Preparamos los campos y mostramos el bot√≥n ***
                    prepareHiddenFieldsAndShowButton(); 
                    return;
                }

                if (message.charAt(charIndex) === '\u2581') {
                    const nextChar = message.charAt(charIndex + 1);
                    charIndex += 2; 

                    if (nextChar === 'P') { setTimeout(type, pauseTime); return; }
                    if (nextChar === 'H') { 
                        textElement.innerHTML += '<div class="ring-icon pulsing">üíç</div>';
                        setTimeout(type, 10);
                        return;
                    } 
                    if (nextChar === 'L') { 
                        textElement.innerHTML += '<br>';
                        setTimeout(type, 10);
                        return;
                    }
                }

                if (message.substring(charIndex, charIndex + 2) === '**') {
                    const nextStarIndex = message.indexOf('**', charIndex + 2);
                    if (nextStarIndex !== -1) {
                        const boldText = message.substring(charIndex + 2, nextStarIndex);
                        const span = document.createElement('span');
                        span.innerHTML = `<strong>${boldText}</strong>`;
                        span.classList.add('highlight'); 
                        textElement.appendChild(span);
                        charIndex = nextStarIndex + 2;
                        setTimeout(type, typingSpeed * boldText.length / 4); 
                        return;
                    }
                }
                
                if (message.substring(charIndex, charIndex + 2) === '||') {
                    const nextDoublePipeIndex = message.indexOf('||', charIndex + 2);
                    if (nextDoublePipeIndex !== -1) {
                        const answerText = message.substring(charIndex + 2, nextDoublePipeIndex);
                        const span = document.createElement('span');
                        span.textContent = answerText;
                        span.classList.add('highlight'); 
                        textElement.appendChild(span);
                        charIndex = nextDoublePipeIndex + 2;
                        setTimeout(type, typingSpeed * answerText.length / 4); 
                        return;
                    }
                }
                
                const char = message.charAt(charIndex);
                const span = document.createElement('span');
                span.textContent = char;
                textElement.appendChild(span);
                
                charIndex++;
                setTimeout(type, typingSpeed);
            }
            type();
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // Asegura que la pantalla de inicio sea la primera en cargarse
            document.getElementById('initialScreen').style.display = 'flex';
        });

    </script>
</body>
</html>
